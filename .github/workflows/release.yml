name: Release

on:
  release:
    types: [published]
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

jobs:
  changelog-and-release:
    name: Version bump, changelog update, and release notes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish || 'main' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate release notes have been edited
        run: |
          # Use heredoc to safely handle backticks and special characters in release body
          RELEASE_BODY=$(cat <<'EOF'
          ${{ github.event.release.body }}
          EOF
          )
          
          # Check if release body still contains the default template markers
          if echo "$RELEASE_BODY" | grep -q "Detailed release notes from CHANGELOG.md will be appended"; then
            echo "❌ ERROR: Release draft has not been edited!"
            echo ""
            echo "Please edit the release draft and replace the template with meaningful notes before publishing."
            echo "The CHANGELOG content will be automatically appended when you re-publish."
            exit 1
          fi
          
          echo "✅ Release notes have been edited"

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Derive version from tag
        id: meta
        run: |
          TAG_NAME="${{ github.event.release.tag_name || github.ref_name }}"
          if [ -z "$TAG_NAME" ]; then
            echo "Tag name missing from event." >&2
            exit 1
          fi

          VERSION="${TAG_NAME#v}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_ENV

      - name: Validate changelog is valid and has a non-empty unreleased section  
        run: |
          npx kacl prerelease

      - name: Bump version in package.json
        run: |
          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Use npm version with the target version
          npm version ${{ steps.meta.outputs.version }} --no-git-tag-version
          
          echo "✅ Updated package.json to version ${{ steps.meta.outputs.version }}"

      - name: Release changelog using keep-a-changelog
        run: |
          npx -p keep-a-changelog changelog --release ${{ steps.meta.outputs.version }}

      - name: Extract release notes from changelog
        id: notes
        run: |
          NOTES=$(npx -p keep-a-changelog changelog --latest-release-full)
          echo "$NOTES"
          {
            echo "body<<'EOF'"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Commit version bump, changelog update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(release): bump version to ${{ steps.meta.outputs.version }} and update CHANGELOG'
          file_pattern: 'package.json package-lock.json backend/version.js frontend/src/config/version.ts CHANGELOG.md'
          branch: ${{ github.event.release.target_commitish || 'main' }}

      - name: Update GitHub release body
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          body: |
            
            ${{ steps.notes.outputs.body }}
          append_body: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-docker-images:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    needs: changelog-and-release
    strategy:
      matrix:
        service: [frontend, backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Docker metadata for ${{ matrix.service }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}/${{ matrix.service }}
          flavor: |
            latest=auto
          tags: |
            type=semver,pattern={{version}},match=(.*)
            type=semver,pattern={{major}}.{{minor}},match=(.*)
            type=semver,pattern={{major}},match=(.*)
            type=ref,event=branch,prefix={{branch}}-
            type=sha,prefix={{branch}}-

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.service }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
