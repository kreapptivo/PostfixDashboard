const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const rootDir = path.resolve(__dirname, '..');
const files = {
  rootPkg: path.join(rootDir, 'package.json'),
  frontendVersion: path.join(rootDir, 'frontend', 'src', 'config', 'version.ts'),
  backendVersion: path.join(rootDir, 'backend', 'version.js'),
};

const args = process.argv.slice(2);
const useTag = args.includes('--from-tag');

function readJson(filePath) {
  return JSON.parse(fs.readFileSync(filePath, 'utf8'));
}

function normalizeVersion(input) {
  if (!input) return null;
  const trimmed = input.trim();
  const match = trimmed.match(/^v?(\d+\.\d+\.\d+(?:-[0-9A-Za-z-.]+)?(?:\+[0-9A-Za-z-.]+)?)$/);
  return match ? match[1] : null;
}

function getLatestTagVersion() {
  try {
    const tag = execSync('git describe --tags --abbrev=0', { stdio: ['ignore', 'pipe', 'ignore'] })
      .toString()
      .trim();
    return normalizeVersion(tag);
  } catch (error) {
    return null;
  }
}

function writeFrontendVersion(version) {
  const banner = '// Auto-generated by scripts/sync-versions.js. Do not edit manually.';
  const body = `${banner}\nconst appVersion = '${version}';\n\nexport { appVersion };\nexport default appVersion;\n`;
  fs.writeFileSync(files.frontendVersion, body);
}

function writeBackendVersion(version) {
  const banner = '// Auto-generated by scripts/sync-versions.js. Do not edit manually.';
  const jsBody = `${banner}\nmodule.exports = { appVersion: '${version}' };\n`;
  fs.writeFileSync(files.backendVersion, jsBody);
}

function main() {
  const rootPkg = readJson(files.rootPkg);
  const fallbackVersion = rootPkg.version;

  let sourceVersion = fallbackVersion;
  if (useTag) {
    const tagVersion = getLatestTagVersion();
    if (tagVersion) {
      sourceVersion = tagVersion;
    }
  }

  writeFrontendVersion(sourceVersion);
  writeBackendVersion(sourceVersion);

  process.stdout.write(`Synced versions to ${sourceVersion}\n`);
}

main();
